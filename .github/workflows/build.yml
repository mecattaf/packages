name: Build QuickShell WebEngine Packages

on:
  workflow_dispatch:
  push:
    paths:
      - 'breakpad/**'
      - 'quickshell-webengine/**'
      - 'dms/**'
      - '.copr/**'
      - '.github/workflows/build.yml'
    branches: [ main, master ]

jobs:
  build-packages:
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[build-all]') ||
      contains(github.event.head_commit.message, '[build-webengine]')
    runs-on: ubuntu-latest
    container:
      image: 'registry.fedoraproject.org/fedora-minimal:latest'

    steps:
      - name: Prepare build environment
        run: |
          microdnf -y install --nodocs --setopt=install_weak_deps=0 \
            copr-cli git tar gzip jq

      - name: Configure COPR
        env:
          COPR_CONF: ${{ secrets.COPR_CONFIG }}
        run: |
          mkdir -p ~/.config
          echo "$COPR_CONF" > ~/.config/copr

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # Build breakpad first (dependency for quickshell-webengine)
      - name: Build breakpad
        run: |
          echo "Building breakpad..."
          breakpad_build_id=$(copr-cli build-package mecattaf/packages --nowait --name breakpad 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          echo "BREAKPAD_BUILD_ID=$breakpad_build_id" >> $GITHUB_ENV
          echo "Breakpad build ID: $breakpad_build_id"

      # Build QuickShell with WebEngine support (depends on breakpad)
      - name: Build quickshell-webengine
        run: |
          echo "Building quickshell-webengine..."
          if [ "$BREAKPAD_BUILD_ID" != "0" ]; then
            quickshell_build_id=$(copr-cli build-package mecattaf/packages --nowait --name quickshell-webengine --after-build-id "$BREAKPAD_BUILD_ID" 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          else
            quickshell_build_id=$(copr-cli build-package mecattaf/packages --nowait --name quickshell-webengine 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          fi
          echo "QUICKSHELL_BUILD_ID=$quickshell_build_id" >> $GITHUB_ENV
          echo "QuickShell WebEngine build ID: $quickshell_build_id"

      # Build DMS (depends on quickshell-webengine)
      - name: Build DMS
        run: |
          echo "Building DMS..."
          if [ "$QUICKSHELL_BUILD_ID" != "0" ]; then
            dms_build_id=$(copr-cli build-package mecattaf/packages --nowait --name dms --after-build-id "$QUICKSHELL_BUILD_ID" 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          else
            dms_build_id=$(copr-cli build-package mecattaf/packages --nowait --name dms 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          fi
          echo "DMS_BUILD_ID=$dms_build_id" >> $GITHUB_ENV
          echo "DMS build ID: $dms_build_id"

      # Check build status
      - name: Check build status
        if: always()
        run: |
          echo "Waiting for builds to register..."
          sleep 60

          echo "=== Build Status Summary ==="
          copr-cli list-builds mecattaf/packages --output-format text-row | head -30

          echo ""
          echo "=== Build IDs ==="
          echo "Breakpad: $BREAKPAD_BUILD_ID"
          echo "QuickShell WebEngine: $QUICKSHELL_BUILD_ID"
          echo "DMS: $DMS_BUILD_ID"

          echo ""
          echo "=== Build Chain ==="
          echo "breakpad → quickshell-webengine → dms"

          echo ""
          echo "Monitor builds at: https://copr.fedorainfracloud.org/coprs/mecattaf/packages/builds/"
          
          echo ""
          echo "=== Package Information ==="
          echo "Breakpad: Google crash-reporting system (build dependency)"
          echo "QuickShell WebEngine: QuickShell with QtWebEngine and QtWebChannel support"
          echo "DMS: DankMaterialShell with React-based web UI components"
          echo "Optimized for GameScope microcompositor"
